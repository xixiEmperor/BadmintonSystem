import{ax as i,ay as N,r as I,d as y,E as u}from"./index-CHTw6ThQ.js";function R(){return i({url:"/api/cart",method:"get"})}function j(t){return i({url:"/api/cart",method:"post",data:t})}function F(t,n){return i({url:`/api/cart/${t}`,method:"put",data:n})}function g(t,n){return i({url:`/api/cart/${t}`,method:"delete",data:n})}function M(t,n){return i({url:`/api/cart/select/${t}`,method:"put",data:n})}function O(t){return i({url:"/api/cart/select-all",method:"put",data:{selected:t}})}function b(){return i({url:"/api/cart",method:"delete"})}const B=N("cart",()=>{const t=I([]),n=I(!1),l=I(!1),C=y(()=>t.value.reduce((e,r)=>e+r.quantity,0)),q=y(()=>t.value.filter(e=>e.selected).reduce((e,r)=>e+(r.productPrice+(r.priceAdjustment||0))*r.quantity,0)),w=y(()=>t.value.filter(e=>e.selected).length);async function f(){if(!l.value){l.value=!0;try{const e=await R();if(e.data.code===0)return t.value=e.data.data.cartItems||[],n.value=e.data.data.allSelected||!1,!0;throw new Error(e.data.message||"获取购物车失败")}catch(e){return console.error("获取购物车失败:",e),u.error("获取购物车失败"),!1}finally{l.value=!1}}}async function S(e){const r=e.specificationId!==void 0,a=t.value.findIndex(o=>r?o.productId===e.productId&&o.specificationId===e.specificationId:o.productId===e.productId&&!o.specificationId);try{if(a>=0){const c=t.value[a];if(c.quantity+e.quantity>c.stock)return u.warning("已达到最大库存数量"),!1;c.quantity+=e.quantity,c.totalPrice=c.productPrice*c.quantity}else t.value.push({...e,quantity:e.quantity,selected:!0,totalPrice:e.productPrice*e.quantity});const o={productId:e.productId,quantity:e.quantity};return e.specificationId&&(o.specs=e.specs),await j(o),!0}catch(o){return console.error("添加到购物车失败:",o),u.error("添加到购物车失败"),!1}}async function p(e,r){if(r<=0)return await v(e);if(r>e.stock)return u.warning(`商品"${e.productName}"已达到最大库存数量(${e.stock})`),!1;try{e.quantity=r,e.totalPrice=e.productPrice*r;const a={quantity:r};return e.specificationId&&(a.specs=e.specs),await F(e.productId,a),!0}catch(a){return console.error("更新数量失败:",a),u.error("更新数量失败"),!1}}async function x(e){return await p(e,e.quantity+1)}async function P(e){return await p(e,e.quantity-1)}async function v(e){const r=t.value.findIndex(a=>e.specificationId?a.productId===e.productId&&a.specificationId===e.specificationId:a.productId===e.productId&&!a.specificationId);if(r===-1)return!1;try{t.value.splice(r,1);const a={};return e.specificationId&&(a.specs=e.specs),await g(e.productId,a),u.success("商品已从购物车中移除"),!0}catch(a){return console.error("删除商品失败:",a),u.error("删除商品失败"),!1}}async function $(e){try{h();const r={selected:e.selected};return e.specificationId&&(r.specs=e.specs),await M(e.productId,r),!0}catch(r){return console.error("更新选择状态失败:",r),u.error("更新选择状态失败"),!1}}async function A(){try{return t.value.forEach(e=>{e.selected=n.value}),await O(n.value),!0}catch(e){return console.error("更新全选状态失败:",e),u.error("更新全选状态失败"),!1}}function h(){t.value.length===0?n.value=!1:n.value=t.value.every(e=>e.selected)}async function E(){try{return t.value=[],n.value=!1,await b(),u.success("购物车已清空"),!0}catch(e){return console.error("清空购物车失败:",e),u.error("清空购物车失败"),!1}}function T(){return t.value.filter(e=>e.selected)}async function k(e){try{let r=[];if(e.product?r=[e.product]:e.products&&(r=e.products),r.length===0)return!0;let a=0,o=0;for(const c of r)try{const d=t.value.findIndex(s=>c.specificationId?s.productId===c.productId&&s.specificationId===c.specificationId:s.productId===c.productId&&!s.specificationId);if(d!==-1){t.value.splice(d,1);const s={};c.specificationId&&(s.specs=c.specs),await g(c.productId,s),a++}else a++}catch(d){console.error(`删除商品失败: ${c.productName}`,d),o++}return h(),o===0?!0:(await f(),!1)}catch(r){return console.error("删除已结算商品失败:",r),await f(),!1}}function L(){l.value=!1}return{cartItems:t,isAllSelected:n,loading:l,totalCount:C,totalPrice:q,selectedCount:w,fetchCartList:f,addToCart:S,updateItemQuantity:p,increaseQuantity:x,decreaseQuantity:P,removeFromCart:v,toggleSelectItem:$,toggleSelectAll:A,clearCart:E,getSelectedItems:T,removeOrderedItems:k,resetLoadingState:L}},{persist:{paths:["cartItems","isAllSelected"],afterRestore:t=>{t.store.loading=!1}}});export{B as u};
