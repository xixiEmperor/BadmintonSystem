import{u as re,r as g,d as L,o as G,q as v,p as w,l as s,j as o,aS as ce,B as n,M as F,w as p,v as de,O as M,aT as ue,s as pe,ac as ve,an as _e,P as J,Q as K,al as me,E as l,b as he,i as _,n as I,aU as ke,aV as X,F as h,aw as N,aq as fe,aH as ye,c as Y}from"./index-CHTw6ThQ.js";/* empty css                    *//* empty css                 *//* empty css                  *//* empty css                  */import{a as we,b as ge,u as Ie,l as Ce,d as Te,e as xe,f as be,h as Pe,i as Z}from"./forum-BJTiRufs.js";/* empty css                       *//* empty css                   */import{_ as Se}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{u as Ve}from"./forum-r9D-h3UH.js";import"./format-BoKD-3ja.js";const Le={class:"post-detail-container"},Ue={key:0,class:"post-header"},Ee={class:"post-info"},Be={class:"author-info"},$e={class:"author-detail"},ze={class:"author-name"},De={class:"publish-time"},Re={class:"post-meta"},Fe={class:"view-count"},Me={class:"delete-post"},Ne={key:1,class:"post-content"},He={class:"post-title"},qe=["innerHTML"],Ae={class:"post-action-bar"},je={class:"comment-section"},Oe={class:"comment-title"},Qe={class:"comment-form"},We={class:"comment-input-container"},Ge={class:"comment-actions"},Je={class:"word-count"},Ke={class:"comment-sort"},Xe={class:"comment-list"},Ye={class:"comment-user"},Ze={class:"comment-content"},es={class:"comment-header"},ss={class:"comment-author"},ts={class:"comment-time"},os={class:"comment-text"},as={class:"comment-footer"},ls={class:"comment-actions"},ns=["onClick"],is=["onClick"],rs={class:"comment-delete-wrapper"},cs=["onClick"],ds={key:0,class:"reply-form"},us={class:"reply-input-container"},ps={class:"reply-actions"},vs={class:"reply-word-count"},_s={class:"reply-buttons"},ms={key:1,class:"reply-list"},hs={class:"reply-user"},ks={class:"reply-content"},fs={class:"reply-header"},ys={class:"reply-author"},ws={class:"reply-time"},gs={class:"reply-text"},Is={key:0,class:"reply-to"},Cs={class:"reply-footer"},Ts={class:"reply-actions"},xs=["onClick"],bs=["onClick"],Ps={class:"reply-delete-wrapper"},Ss=["onClick"],Vs={key:0,class:"reply-form nested-reply-form"},Ls={class:"reply-input-container"},Us={class:"reply-actions"},Es={class:"reply-word-count"},Bs={class:"reply-buttons"},$s=["onClick"],zs={__name:"PostDetail",setup(Ds){const y=me(),x=he(),b=re(),C=Ve(),ee=g();ee.value=b.userInfo;const r=L(()=>C.currentPost||{}),U=async()=>{const t=y.params.id,e=await we(t);e.data.code===0?C.setCurrentPost(e.data.data):l.error(e.data.msg)};G(()=>{U()});const E=L(()=>C.comments||[]),P=g("time_desc"),H=g("new"),S=async()=>{const t=y.params.id,e=await ge(t,P.value);e.data.code===0&&C.setComments(e.data.data)};G(()=>{S()});const T=g(""),q=L(()=>r.value&&r.value.replyCount!==void 0?r.value.replyCount:E.value?E.value.length:0),i=g({commentId:null,replyId:null,replyToUserId:null,content:"",placeholder:""}),B=g(!1),f=g({}),z=L(()=>E.value?E.value:[]),se=L(()=>B.value?z.value:z.value.slice(0,3)),A=async t=>{if(!b.token){l.warning("请先登录后再点赞"),x.push("/login");return}try{const e=y.params.id,d=t.id;if(t.isLiked){const u=await Te(e,d);u.data.code===0?(t.likes-=1,t.isLiked=!1,l.success("已取消点赞")):l.error(u.data.msg||"操作失败")}else{const u=await xe(e,d);u.data.code===0?(t.likes+=1,t.isLiked=!0,l.success("点赞成功")):l.error(u.data.msg||"操作失败")}}catch(e){console.error("点赞操作失败",e),l.error("操作失败，请稍后重试")}},te=async()=>{if(T.value.trim()===""){l.warning("评论内容不能为空");return}if(!b.token){l.warning("请先登录后再评论"),x.push("/login");return}try{const t=y.params.id,e=await Z(t,{content:T.value,parentId:null});e.data.code===0?(await S(),await U(),T.value="",l.success("评论发表成功")):l.error(e.data.msg||"评论发表失败")}catch(t){console.error("评论发表失败",t),l.error("评论发表失败，请稍后重试")}},j=(t,e=null)=>{Y.confirm("确定要删除这条评论吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async()=>{try{const d=y.params.id,u=t.id,m=await be(d,u);if(m.data.code===0){if(e){const k=e.children.findIndex(V=>V.id===t.id);k!==-1&&e.children.splice(k,1)}else await S();await U(),l.success("删除成功")}else l.error(m.data.msg||"删除失败")}catch(d){console.error("删除评论失败",d),l.error("删除失败，请稍后重试")}}).catch(()=>{})},O=(t,e=null)=>{if(!b.token){l.warning("请先登录后再回复"),x.push("/login");return}let d=`回复 ${t.nickname}：`,u=null,m=null,k=t.userId;e?(u=e.id,m=t.id,k=t.userId,d=`回复 @${t.nickname}：`,f.value={...f.value,[e.id]:!0}):(u=t.id,m=null,k=t.userId),i.value={commentId:u,replyId:m,replyToUserId:k,content:"",placeholder:d}},D=()=>{i.value={commentId:null,replyId:null,replyToUserId:null,content:"",placeholder:""}},Q=async()=>{if(!i.value.content.trim()){l.warning("回复内容不能为空");return}try{const t=y.params.id,e={content:i.value.content,parentId:i.value.commentId};i.value.replyId&&(e.replyToId=i.value.replyId),i.value.replyToUserId&&(e.replyToUserId=i.value.replyToUserId);const d=await Z(t,e);d.data.code===0?(await S(),await U(),i.value.commentId&&(f.value={...f.value,[i.value.commentId]:!0}),D(),l.success("回复成功")):l.error(d.data.msg||"回复失败")}catch(t){console.error("提交回复失败",t),l.error("回复失败，请稍后重试")}},oe=()=>{B.value=!B.value},ae=t=>{f.value={...f.value,[t]:!f.value[t]}},le=t=>{t==="hot"?P.value="likes":t==="new"?P.value="time_desc":t==="old"?P.value="time_asc":P.value="time_desc",S()},W=async()=>{if(!b.token){l.warning("请先登录后再点赞"),x.push("/login");return}try{const t=y.params.id;if(r.value.isLiked){const e=await Ie(t);if(e.data.code===0){const d={...r.value,isLiked:!1,likes:r.value.likes-1};C.setCurrentPost(d),l.success("已取消点赞")}else l.error(e.data.msg||"操作失败")}else{const e=await Ce(t);if(e.data.code===0){const d={...r.value,isLiked:!0,likes:r.value.likes+1};C.setCurrentPost(d),l.success("点赞成功")}else l.error(e.data.msg||"操作失败")}}catch(t){console.error("点赞操作失败",t),l.error("操作失败，请稍后重试")}},ne=()=>{Y.confirm("确定要删除这篇帖子吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async()=>{try{const t=y.params.id,e=await Pe(t);e.data.code===0?(l.success("帖子删除成功"),x.push("/forum")):l.error(e.data.msg||"删除失败")}catch(t){console.error("删除帖子失败",t),l.error("删除失败，请稍后重试")}}).catch(()=>{})};return(t,e)=>{const d=ce,u=de,m=pe,k=ve,V=fe,ie=_e,R=ue("auth");return _(),v("div",Le,[r.value?(_(),v("div",Ue,[s("div",Ee,[s("div",Be,[o(d,{size:40,src:r.value.authorAvatar,class:"author-avatar"},null,8,["src"]),s("div",$e,[s("div",ze,n(r.value.author),1),s("div",De,n(r.value.publishTime),1)])]),s("div",Re,[s("div",Fe,[o(u,null,{default:p(()=>[o(I(ke))]),_:1}),s("span",null,n(r.value.views)+" 次浏览",1)]),s("div",{class:M(["like-count",{"is-liked":r.value.isLiked}]),onClick:W},[o(u,null,{default:p(()=>[o(I(X))]),_:1}),s("span",null,n(r.value.likes)+" 点赞",1)],2),F((_(),v("div",Me,[o(m,{type:"danger",size:"small",onClick:ne},{default:p(()=>[o(u,null,{default:p(()=>[o(I(N))]),_:1}),e[4]||(e[4]=h(" 删除帖子 "))]),_:1})])),[[R,r.value.author]])])])])):w("",!0),r.value?(_(),v("div",Ne,[s("h1",He,n(r.value.title),1),s("div",{class:"content",innerHTML:r.value.content},null,8,qe),s("div",Ae,[o(m,{type:"primary",plain:!r.value.isLiked,onClick:W,class:"like-button"},{default:p(()=>[o(u,null,{default:p(()=>[o(I(X))]),_:1}),h(" "+n(r.value.isLiked?"已点赞":"点赞")+" "+n(r.value.likes),1)]),_:1},8,["plain"])])])):w("",!0),s("div",je,[s("h3",Oe,"评论 "+n(q.value),1),s("div",Qe,[s("div",We,[o(k,{modelValue:T.value,"onUpdate:modelValue":e[0]||(e[0]=a=>T.value=a),type:"textarea",rows:"3",placeholder:"平等表达，友善交流",maxlength:"1000","show-word-limit":""},null,8,["modelValue"])]),s("div",Ge,[s("span",Je,n(T.value.length)+" / 1000",1),o(m,{type:"primary",onClick:te},{default:p(()=>e[5]||(e[5]=[h("发送")])),_:1})])]),s("div",Ke,[o(ie,{modelValue:H.value,"onUpdate:modelValue":e[1]||(e[1]=a=>H.value=a),onTabChange:le},{default:p(()=>[o(V,{label:"最热",name:"hot"}),o(V,{label:"最新",name:"new"}),o(V,{label:"最早",name:"old"})]),_:1},8,["modelValue"])]),s("div",Xe,[(_(!0),v(J,null,K(se.value,a=>(_(),v("div",{key:a.id,class:"comment-item"},[s("div",Ye,[o(d,{size:36,src:a.avatar},{default:p(()=>[h(n(a.nickname[0]),1)]),_:2},1032,["src"])]),s("div",Ze,[s("div",es,[s("span",ss,n(a.nickname),1),s("span",ts,n(a.replyTime),1)]),s("div",os,n(a.content),1),s("div",as,[s("div",ls,[s("span",{class:M(["comment-like",{"is-liked":a.isLiked}]),onClick:c=>A(a)},[o(u,null,{default:p(()=>[o(I(ye))]),_:1}),h(" 点赞 "+n(a.likes),1)],10,ns),s("span",{class:"comment-reply",onClick:c=>O(a)},"回复",8,is)]),F((_(),v("div",rs,[s("span",{class:"comment-delete",onClick:c=>j(a)},[o(u,null,{default:p(()=>[o(I(N))]),_:1}),e[6]||(e[6]=h(" 删除 "))],8,cs)])),[[R,a.nickname]])]),i.value.commentId===a.id&&!i.value.replyId?(_(),v("div",ds,[s("div",us,[o(k,{modelValue:i.value.content,"onUpdate:modelValue":e[2]||(e[2]=c=>i.value.content=c),type:"textarea",rows:"2",placeholder:i.value.placeholder,maxlength:"500","show-word-limit":""},null,8,["modelValue","placeholder"])]),s("div",ps,[s("span",vs,n(i.value.content.length)+" / 500",1),s("div",_s,[o(m,{size:"small",onClick:D},{default:p(()=>e[7]||(e[7]=[h("取消")])),_:1}),o(m,{size:"small",type:"primary",onClick:Q},{default:p(()=>e[8]||(e[8]=[h("回复")])),_:1})])])])):w("",!0),a.children&&a.children.length?(_(),v("div",ms,[(_(!0),v(J,null,K(f.value[a.id]?a.children:a.children.slice(0,3),c=>(_(),v("div",{key:c.id,class:"reply-item"},[s("div",hs,[o(d,{size:30,src:c.avatar},{default:p(()=>[h(n(c.nickname[0]),1)]),_:2},1032,["src"])]),s("div",ks,[s("div",fs,[s("span",ys,n(c.nickname),1),s("span",ws,n(c.replyTime),1)]),s("div",gs,[c.replyToNickname?(_(),v("span",Is,"回复 @"+n(c.replyToNickname)+"：",1)):w("",!0),h(" "+n(c.content),1)]),s("div",Cs,[s("div",Ts,[s("span",{class:M(["reply-like",{"is-liked":c.isLiked}]),onClick:$=>A(c)}," 点赞 "+n(c.likes),11,xs),s("span",{class:"reply-button",onClick:$=>O(c,a)},"回复",8,bs)]),F((_(),v("div",Ps,[s("span",{class:"reply-delete",onClick:$=>j(c,a)},[o(u,null,{default:p(()=>[o(I(N))]),_:1}),e[9]||(e[9]=h(" 删除 "))],8,Ss)])),[[R,c.nickname]])]),i.value.commentId===a.id&&i.value.replyId===c.id?(_(),v("div",Vs,[s("div",Ls,[o(k,{modelValue:i.value.content,"onUpdate:modelValue":e[3]||(e[3]=$=>i.value.content=$),type:"textarea",rows:"2",placeholder:i.value.placeholder,maxlength:"500","show-word-limit":"",autofocus:""},null,8,["modelValue","placeholder"])]),s("div",Us,[s("span",Es,n(i.value.content.length)+" / 500",1),s("div",Bs,[o(m,{size:"small",onClick:D},{default:p(()=>e[10]||(e[10]=[h("取消")])),_:1}),o(m,{size:"small",type:"primary",onClick:Q},{default:p(()=>e[11]||(e[11]=[h("回复")])),_:1})])])])):w("",!0)])]))),128)),a.children.length>3?(_(),v("div",{key:0,class:"view-more-replies",onClick:c=>ae(a.id)},n(f.value[a.id]?"收起回复":`查看全部 ${a.children.length} 条回复`),9,$s)):w("",!0)])):w("",!0)])]))),128)),z.value.length>3?(_(),v("div",{key:0,class:"view-more-comments",onClick:oe},n(B.value?"收起评论":`查看全部 ${q.value} 条评论`),1)):w("",!0)])])])}}},Gs=Se(zs,[["__scopeId","data-v-491d4d46"]]);export{Gs as default};
